<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{BOOK_TITLE}} — 閱讀報告</title>
<style>
  /* ===== Design Token: Light ===== */
  :root,
  [data-theme="light"] {
    --color-bg:      #f8f6f1;
    --color-surface: #ffffff;
    --color-ink:     #1c1917;
    --color-body:    #44403c;
    --color-muted:   #6b6560;
    --color-rule:    #d6d3d1;
    --color-accent:  #8d7048;
    --color-accent-light: #f5f0e8;

    --font-serif:  Baskerville, "Noto Serif TC", Georgia, "Times New Roman", serif;
    --font-sans:   "Noto Sans TC", "PingFang TC", system-ui, -apple-system, sans-serif;

    --width-content: 660px;
    --spacing-section: 3.5rem;
  }

  /* ===== Design Token: Dark ===== */
  [data-theme="dark"] {
    --color-bg:      #1a1814;
    --color-surface: #252220;
    --color-ink:     #e8e4de;
    --color-body:    #b8b0a4;
    --color-muted:   #8a8278;
    --color-rule:    #3d3830;
    --color-accent:  #c4a06a;
    --color-accent-light: #2a2520;
  }

  /* ===== System preference fallback ===== */
  @media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) {
      --color-bg:      #1a1814;
      --color-surface: #252220;
      --color-ink:     #e8e4de;
      --color-body:    #b8b0a4;
      --color-muted:   #8a8278;
      --color-rule:    #3d3830;
      --color-accent:  #c4a06a;
      --color-accent-light: #2a2520;
    }
  }

  /* ===== Reset ===== */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 17px; -webkit-font-smoothing: antialiased; }

  body {
    font-family: var(--font-serif);
    background: var(--color-bg);
    color: var(--color-body);
    line-height: 1.75;
    min-height: 100vh;
    transition: background-color 0.3s, color 0.3s;
  }

  /* ===== Typography ===== */
  h1, h2, h3 {
    font-family: var(--font-serif);
    color: var(--color-ink);
    font-weight: 600;
    line-height: 1.35;
  }
  h2 {
    font-size: 1.35rem;
    letter-spacing: 0.02em;
    margin-bottom: 1.5rem;
  }
  h3 {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
  }
  p { margin-bottom: 0.85rem; }
  p:last-child { margin-bottom: 0; }

  /* ===== Layout ===== */
  .page {
    max-width: var(--width-content);
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* ===== Skip Link ===== */
  .skip-link {
    position: absolute;
    top: -100%;
    left: 1rem;
    z-index: 100;
    padding: 0.5rem 1rem;
    background: var(--color-surface);
    color: var(--color-ink);
    font-family: var(--font-sans);
    font-size: 0.85rem;
    text-decoration: none;
    border: 1px solid var(--color-rule);
  }
  .skip-link:focus {
    top: 1rem;
  }

  /* ===== Header ===== */
  .header {
    text-align: center;
    padding: 4rem 1.5rem 3rem;
    border-bottom: 1px solid var(--color-rule);
  }
  .header__tag {
    display: inline-block;
    font-family: var(--font-sans);
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--color-accent);
    margin-bottom: 1.5rem;
  }
  .header__title {
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 0.01em;
    margin-bottom: 0.4rem;
  }
  .header__author {
    font-size: 1rem;
    color: var(--color-muted);
    margin-bottom: 1.5rem;
  }
  .header__verdict {
    font-style: italic;
    font-size: 1.05rem;
    color: var(--color-body);
    max-width: 540px;
    margin: 0 auto;
    line-height: 1.75;
  }

  /* ===== Book Introduction ===== */
  .book-intro {
    padding: 2rem 0;
    border-bottom: 1px solid var(--color-rule);
  }
  .book-intro__text {
    font-size: 0.95rem;
    color: var(--color-body);
    line-height: 1.85;
    max-width: var(--width-content);
  }

  /* ===== TIPS Scores ===== */
  .tips-scores {
    padding: 2rem 0;
    border-bottom: 1px solid var(--color-rule);
  }
  .tips-scores__label {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-accent);
    margin-bottom: 1rem;
  }
  .tips-scores__grid {
    display: flex;
    gap: 2.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }
  .tips-scores__item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .tips-scores__dim {
    font-family: var(--font-sans);
    font-size: 0.78rem;
    color: var(--color-muted);
    letter-spacing: 0.02em;
  }
  .tips-scores__dots {
    display: flex;
    gap: 0.35rem;
    font-size: 0.9rem;
    line-height: 1;
    letter-spacing: 0.1em;
  }
  .tips-scores__dot--filled {
    color: var(--color-accent);
  }
  .tips-scores__dot--empty {
    color: var(--color-rule);
  }
  .tips-scores__total {
    font-family: var(--font-sans);
    font-size: 0.85rem;
    color: var(--color-body);
    margin-bottom: 0.75rem;
  }
  .tips-scores__total strong {
    color: var(--color-ink);
  }
  .tips-scores__legend {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--color-muted);
    letter-spacing: 0.02em;
    padding-top: 0.75rem;
    border-top: 1px solid var(--color-rule);
  }

  /* ===== Toolbar ===== */
  .toolbar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--color-rule);
    font-family: var(--font-sans);
    font-size: 0.8rem;
  }
  .toolbar-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-family: var(--font-sans);
    font-size: 0.78rem;
    font-weight: 500;
    background: none;
    border: 1px solid var(--color-rule);
    padding: 0.35rem 0.7rem;
    cursor: pointer;
    color: var(--color-muted);
    transition: color 0.2s, border-color 0.2s;
    line-height: 1;
    letter-spacing: 0.02em;
  }
  .toolbar-btn:hover {
    color: var(--color-ink);
    border-color: var(--color-accent);
  }
  .toolbar-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
  .toolbar-btn svg {
    flex-shrink: 0;
  }

  /* ===== Section ===== */
  .section {
    padding: var(--spacing-section) 0;
    border-bottom: 1px solid var(--color-rule);
  }
  .section:last-of-type {
    border-bottom: none;
  }
  .section__label {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-accent);
    margin-bottom: 0.6rem;
  }

  /* ===== Tabs ===== */
  .tabs {
    margin-top: 2rem;
  }
  .tab-nav {
    display: flex;
    gap: 2rem;
    border-bottom: 1px solid var(--color-rule);
    list-style: none;
    margin-bottom: 2rem;
  }
  .tab-nav [role="tab"] {
    font-family: var(--font-sans);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--color-muted);
    background: none;
    border: none;
    padding: 0.6rem 0;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: color 0.2s, border-color 0.2s;
    letter-spacing: 0.02em;
  }
  .tab-nav [role="tab"]:hover {
    color: var(--color-ink);
  }
  .tab-nav [role="tab"][aria-selected="true"] {
    color: var(--color-ink);
    border-bottom-color: var(--color-accent);
  }
  .tab-nav [role="tab"]:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 2px;
  }
  .tab-panel {
    display: none;
  }
  .tab-panel[aria-hidden="false"] {
    display: block;
    animation: fadeIn 0.35s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  /* ===== Arguments (native details/summary) ===== */
  .argument {
    border-bottom: 1px solid var(--color-rule);
    padding: 1.25rem 0;
  }
  .argument:last-child { border-bottom: none; }
  .argument > summary {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    list-style: none;
    cursor: pointer;
    font-family: var(--font-serif);
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--color-ink);
    line-height: 1.5;
  }
  .argument > summary::-webkit-details-marker { display: none; }
  .argument > summary::marker { display: none; content: ""; }
  .argument > summary:hover { color: var(--color-accent); }
  .argument > summary:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
    border-radius: 2px;
  }
  .argument__arrow {
    font-size: 0.65rem;
    color: var(--color-muted);
    transition: transform 0.25s ease;
    flex-shrink: 0;
    margin-left: 1rem;
  }
  .argument[open] .argument__arrow {
    transform: rotate(90deg);
  }
  .argument__body {
    padding-top: 1rem;
  }

  /* ===== Concept list ===== */
  .concept-list {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }
  .concept {
    padding-bottom: 1.75rem;
    border-bottom: 1px solid var(--color-rule);
  }
  .concept:last-child { border-bottom: none; padding-bottom: 0; }
  .concept__name {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--color-ink);
    margin-bottom: 0.4rem;
  }
  .concept__def {
    font-size: 0.92rem;
    color: var(--color-body);
  }

  /* ===== Concept relations ===== */
  .relations {
    margin-top: 2.5rem;
    padding: 1.5rem;
    background: var(--color-accent-light);
  }
  .relations__title {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--color-accent);
    margin-bottom: 1rem;
  }
  .relations svg { max-width: 100%; height: auto; }

  /* ===== Critical prose ===== */
  .prose { line-height: 2; }
  .prose h3 { margin-top: 1.75rem; margin-bottom: 0.6rem; }
  .prose ul, .prose ol { padding-left: 1.25rem; margin-bottom: 1rem; }
  .prose li { margin-bottom: 0.35rem; }

  /* ===== Quotes ===== */
  .quote {
    padding: 1.5rem 0 1.5rem 1.75rem;
    border-left: 2px solid var(--color-accent);
    margin-bottom: 2rem;
  }
  .quote:last-child { margin-bottom: 0; }
  .quote__text {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    font-style: italic;
    line-height: 1.85;
    color: var(--color-ink);
    margin-bottom: 0.6rem;
  }
  .quote__source {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    color: var(--color-muted);
    font-style: normal;
  }

  /* ===== Actions ===== */
  .action-list {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
    counter-reset: action;
  }
  .action-item {
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
    padding-bottom: 1.75rem;
    border-bottom: 1px solid var(--color-rule);
    counter-increment: action;
  }
  .action-item:last-child { border-bottom: none; padding-bottom: 0; }
  .action-item::before {
    content: counter(action);
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-accent);
    line-height: 1;
    flex-shrink: 0;
    min-width: 1.5rem;
    padding-top: 0.15rem;
  }
  .action-item__content h4 {
    font-family: var(--font-serif);
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-ink);
    margin-bottom: 0.25rem;
    line-height: 1.4;
  }
  .action-item__content p {
    font-size: 0.92rem;
    margin-bottom: 0;
  }
  .action-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem 1.25rem;
    margin-top: 0.5rem;
    font-family: var(--font-sans);
    font-size: 0.78rem;
    color: var(--color-muted);
  }
  .action-meta span::before {
    content: "\25B8";
    display: inline-block;
    margin-right: 0.3rem;
    font-size: 0.65em;
    color: var(--color-accent);
  }

  /* ===== Concept boundary ===== */
  .concept__boundary {
    font-size: 0.85em;
    color: var(--color-muted);
    margin-top: 0.25rem;
  }
  .concept__boundary::before {
    content: "";
    display: inline-block;
    width: 2px;
    height: 0.8em;
    background: var(--color-accent);
    margin-right: 0.5em;
    vertical-align: middle;
  }

  /* ===== Meta Knowledge ===== */
  .meta-list { display: flex; flex-direction: column; gap: 1.5rem; }
  .meta-item__lens {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    color: var(--color-ink);
    margin-bottom: 0.5rem;
  }
  .meta-item__desc {
    color: var(--color-body);
    line-height: 1.75;
  }
  .meta-item__delta {
    font-size: 0.9em;
    color: var(--color-muted);
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 2px solid var(--color-accent);
  }

  /* ===== Zettelkasten ===== */
  .zettel-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }
  .zettel-list li {
    font-size: 0.92rem;
    line-height: 1.65;
  }
  .zettel-list__type {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--color-accent);
    margin-right: 0.5rem;
  }
  .zettel-list__link {
    font-weight: 600;
    color: var(--color-ink);
  }
  .zettel-list__reason {
    color: var(--color-muted);
  }
  .zettel-list__link-to {
    color: var(--color-muted);
    font-size: 0.9em;
  }

  /* ===== Further Reading ===== */
  .further-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .further-item {
    padding-bottom: 1.25rem;
    border-bottom: 1px solid var(--color-rule);
  }
  .further-item:last-child { border-bottom: none; padding-bottom: 0; }
  .further-item__title {
    font-weight: 600;
    color: var(--color-ink);
    font-size: 1rem;
  }
  .further-item__reason {
    font-size: 0.92rem;
    color: var(--color-body);
    margin-top: 0.2rem;
  }

  /* ===== Footer ===== */
  .footer {
    text-align: center;
    padding: 2.5rem 1rem;
    margin-top: 1rem;
    font-family: var(--font-sans);
    font-size: 0.78rem;
    color: var(--color-muted);
    letter-spacing: 0.03em;
  }
  .footer__brand {
    color: var(--color-accent);
    font-weight: 600;
  }

  /* ===== Responsive ===== */
  @media (max-width: 640px) {
    html { font-size: 16px; }
    .header { padding: 3rem 1rem 2.25rem; }
    .header__title { font-size: 1.6rem; }
    .toolbar { flex-wrap: wrap; gap: 0.75rem; padding: 1rem; }
    .tab-nav {
      gap: 1.25rem;
      overflow-x: auto;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      mask-image: linear-gradient(to right, transparent 0, #000 0.5rem, #000 calc(100% - 1.5rem), transparent);
      -webkit-mask-image: linear-gradient(to right, transparent 0, #000 0.5rem, #000 calc(100% - 1.5rem), transparent);
      padding-right: 1.5rem;
    }
    .tab-nav [role="tab"] { font-size: 0.8rem; white-space: nowrap; }
    .quote { padding-left: 1.25rem; }
    .action-item { gap: 1rem; }
    .tips-scores__grid { gap: 1.5rem; }
  }

  /* ===== Print ===== */
  @media print {
    @page { margin: 2cm; }
    :root { --color-bg: #fff; --color-surface: #fff; --color-ink: #1c1917; --color-body: #44403c; --color-muted: #6b6560; --color-rule: #d6d3d1; --color-accent: #8d7048; --color-accent-light: #f5f0e8; }
    html { font-size: 11pt; }
    body { background: #fff; }
    .skip-link, .toolbar { display: none; }
    .header { border-bottom: 2px solid var(--color-ink); padding: 1rem 0; }
    .tab-nav { display: none; }
    .tab-panel {
      display: block !important;
      page-break-inside: avoid;
    }
    .tab-panel::before {
      content: attr(data-print-title);
      display: block;
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--color-rule);
    }
    .argument[open] > .argument__body,
    .argument > .argument__body { display: block; }
    .argument { border-bottom: none; }
    .argument__arrow { display: none; }
    .quote, .action-item, .concept { break-inside: avoid; }
    .section { padding: 2rem 0; break-before: avoid; }
    .footer { font-size: 9pt; }
  }

  /* ===== Reduced Motion ===== */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* ===== Utility ===== */
  .sr-only {
    position: absolute;
    width: 1px; height: 1px;
    padding: 0; margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
  }
</style>
</head>
<body>

  <a href="#main-content" class="skip-link">跳至主要內容</a>

  <!-- ==================== HEADER ==================== -->
  <header class="header" role="banner">
    <div class="page">
      <p class="header__tag">{{BOOK_TYPE_TAG}}</p>
      <h1 class="header__title">{{BOOK_TITLE}}</h1>
      <p class="header__author">{{BOOK_AUTHOR}}</p>
      <p class="header__verdict">{{ONE_LINE_REVIEW}}</p>
    </div>
  </header>

  <!-- ==================== BOOK INTRODUCTION ==================== -->
  <div class="book-intro page">
    <p class="book-intro__text">{{BOOK_INTRODUCTION}}</p>
  </div>

  <!-- ==================== TIPS SCORES ==================== -->
  {{TIPS_SCORES_HTML}}

  <!-- ==================== TOOLBAR ==================== -->
  <div class="toolbar page" role="toolbar" aria-label="檢視設定">
    <button type="button" class="toolbar-btn" id="copy-md" aria-label="複製為 Markdown">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="5.5" y="5.5" width="8" height="8" rx="1.5"/><path d="M3.5 10.5V3a1.5 1.5 0 0 1 1.5-1.5H10.5"/></svg>
      <span id="copy-md-text">複製為 Markdown</span>
    </button>
    <button type="button" class="toolbar-btn" id="theme-toggle" aria-label="切換深色模式">
      <span aria-hidden="true" id="theme-icon">&#9790;</span>
      <span id="theme-text">深色模式</span>
    </button>
  </div>

  <main class="page" id="main-content">

    <!-- ==================== ANALYSIS TABS ==================== -->
    <section class="section" aria-label="深度分析">
      <p class="section__label">深度分析</p>
      <h2>這本書說了什麼，以及它說得對不對</h2>

      <div class="tabs">
        <ul class="tab-nav" role="tablist" aria-label="分析面向">
          <li role="presentation">
            <button role="tab" id="tab-arguments" aria-selected="true"
                    aria-controls="panel-arguments" tabindex="0">核心論點</button>
          </li>
          <li role="presentation">
            <button role="tab" id="tab-concepts" aria-selected="false"
                    aria-controls="panel-concepts" tabindex="-1">關鍵概念</button>
          </li>
          <li role="presentation">
            <button role="tab" id="tab-critical" aria-selected="false"
                    aria-controls="panel-critical" tabindex="-1">批判視角</button>
          </li>
        </ul>

        <div role="tabpanel" id="panel-arguments" aria-labelledby="tab-arguments"
             aria-hidden="false" class="tab-panel" tabindex="0"
             data-print-title="核心論點">
          {{CORE_ARGUMENTS_HTML}}
        </div>

        <div role="tabpanel" id="panel-concepts" aria-labelledby="tab-concepts"
             aria-hidden="true" class="tab-panel" tabindex="-1"
             data-print-title="關鍵概念">
          <div class="relations">
            <p class="relations__title">概念關係</p>
            {{CONCEPT_RELATIONS_SVG}}
          </div>
          <div class="concept-list">
            {{KEY_CONCEPTS_HTML}}
          </div>
        </div>

        <div role="tabpanel" id="panel-critical" aria-labelledby="tab-critical"
             aria-hidden="true" class="tab-panel" tabindex="-1"
             data-print-title="批判視角">
          <div class="prose">
            {{CRITICAL_PERSPECTIVES_HTML}}
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== QUOTES ==================== -->
    <section class="section" aria-label="精選引句">
      <p class="section__label">精選引句</p>
      <h2>值得反覆咀嚼的段落</h2>
      {{QUOTES_HTML}}
    </section>

    <!-- ==================== ACTIONS ==================== -->
    <section class="section" aria-label="行動方案">
      <p class="section__label">行動方案</p>
      <h2>讀完之後，具體可以做什麼</h2>
      <div class="action-list">
        {{ACTION_CARDS_HTML}}
      </div>
    </section>

    <!-- ==================== META KNOWLEDGE ==================== -->
    {{META_KNOWLEDGE_HTML}}

    <!-- ==================== ZETTELKASTEN ==================== -->
    <section class="section" aria-label="知識連結">
      <p class="section__label">知識連結</p>
      <h2>與你的知識庫如何連結</h2>
      <ul class="zettel-list">
        {{ZETTELKASTEN_HTML}}
      </ul>
    </section>

    <!-- ==================== FURTHER READING ==================== -->
    <section class="section" aria-label="延伸閱讀">
      <p class="section__label">延伸閱讀</p>
      <h2>接下來可以讀什麼</h2>
      <div class="further-list">
        {{FURTHER_READING_HTML}}
      </div>
    </section>

  </main>

  <!-- ==================== FOOTER ==================== -->
  <footer class="footer" role="contentinfo">
    <p>Generated by <span class="footer__brand">CRISP 閱讀解構師</span></p>
    <p>{{GENERATION_DATE}}</p>
  </footer>

  <!-- ==================== JAVASCRIPT ==================== -->
  <script>
  (function () {
    "use strict";

    /* === Theme toggle === */
    var themeBtn = document.getElementById("theme-toggle");
    var themeIcon = document.getElementById("theme-icon");
    var themeText = document.getElementById("theme-text");
    var html = document.documentElement;

    function setTheme(theme) {
      html.setAttribute("data-theme", theme);
      themeIcon.textContent = theme === "dark" ? "\u2600" : "\u263E";
      themeText.textContent = theme === "dark" ? "淺色模式" : "深色模式";
      themeBtn.setAttribute("aria-label", theme === "dark" ? "切換淺色模式" : "切換深色模式");
      try { localStorage.setItem("crisp-theme", theme); } catch (e) {}
    }

    /* Restore saved preference or follow system */
    var saved;
    try { saved = localStorage.getItem("crisp-theme"); } catch (e) {}
    if (saved) {
      setTheme(saved);
    } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
      setTheme("dark");
    }

    themeBtn.addEventListener("click", function () {
      setTheme(html.getAttribute("data-theme") === "dark" ? "light" : "dark");
    });

    /* === Tab navigation === */
    var tabList = document.querySelector('[role="tablist"]');
    var tabs = Array.from(tabList.querySelectorAll('[role="tab"]'));
    var panels = tabs.map(function (t) {
      return document.getElementById(t.getAttribute("aria-controls"));
    });

    function activate(tab) {
      tabs.forEach(function (t) {
        t.setAttribute("aria-selected", "false");
        t.setAttribute("tabindex", "-1");
      });
      panels.forEach(function (p) {
        p.setAttribute("aria-hidden", "true");
        p.setAttribute("tabindex", "-1");
      });
      tab.setAttribute("aria-selected", "true");
      tab.setAttribute("tabindex", "0");
      var activePanel = document.getElementById(tab.getAttribute("aria-controls"));
      activePanel.setAttribute("aria-hidden", "false");
      activePanel.setAttribute("tabindex", "0");
      activePanel.focus();
    }

    tabList.addEventListener("click", function (e) {
      var t = e.target.closest('[role="tab"]');
      if (t) activate(t);
    });

    tabList.addEventListener("keydown", function (e) {
      var i = tabs.indexOf(document.activeElement);
      if (i === -1) return;
      var n;
      switch (e.key) {
        case "ArrowRight": case "ArrowDown":
          e.preventDefault(); n = (i + 1) % tabs.length; activate(tabs[n]); break;
        case "ArrowLeft": case "ArrowUp":
          e.preventDefault(); n = (i - 1 + tabs.length) % tabs.length; activate(tabs[n]); break;
        case "Home": e.preventDefault(); activate(tabs[0]); break;
        case "End":  e.preventDefault(); activate(tabs[tabs.length - 1]); break;
      }
    });

    /* Force all details open for print */
    if (window.matchMedia) {
      window.matchMedia("print").addEventListener("change", function (e) {
        if (!e.matches) return;
        document.querySelectorAll("details.argument").forEach(function (d) {
          d.setAttribute("open", "");
        });
      });
    }

    /* === Copy as Markdown === */
    var copyBtn = document.getElementById("copy-md");
    var copyText = document.getElementById("copy-md-text");
    copyBtn.addEventListener("click", function () {
      var md = [];
      var title = document.querySelector(".header__title");
      var author = document.querySelector(".header__author");
      var verdict = document.querySelector(".header__verdict");
      var intro = document.querySelector(".book-intro__text");

      md.push("# " + (title ? title.textContent.trim() : ""));
      if (author) md.push("**" + author.textContent.trim() + "**");
      if (verdict) md.push("*" + verdict.textContent.trim() + "*");
      md.push("");

      /* Book introduction */
      if (intro && intro.textContent.trim()) {
        md.push("## 書籍簡介");
        md.push(intro.textContent.trim());
        md.push("");
      }

      /* TIPS scores */
      var tipsItems = document.querySelectorAll(".tips-scores__item");
      if (tipsItems.length > 0) {
        md.push("## TIPS 評分");
        tipsItems.forEach(function (item) {
          var dots = item.querySelector(".tips-scores__dots");
          var dim = item.querySelector(".tips-scores__dim");
          var filled = dots ? dots.querySelectorAll(".tips-scores__dot--filled").length : 0;
          if (dim) md.push("- **" + dim.textContent.trim() + "**: " + filled + "/3");
        });
        var total = document.querySelector(".tips-scores__total");
        if (total) md.push("\n" + total.textContent.trim());
        md.push("");
      }

      /* Core arguments */
      var args = document.querySelectorAll(".argument");
      if (args.length > 0) {
        md.push("## 核心論點");
        args.forEach(function (a) {
          var sum = a.querySelector("summary");
          var body = a.querySelector(".argument__body");
          if (sum) md.push("### " + sum.textContent.replace(/[▶►▸]/g, "").trim());
          if (body) md.push(body.textContent.trim());
          md.push("");
        });
      }

      /* Key concepts */
      var concepts = document.querySelectorAll(".concept");
      if (concepts.length > 0) {
        md.push("## 關鍵概念");
        concepts.forEach(function (c) {
          var name = c.querySelector(".concept__name");
          var def = c.querySelector(".concept__def");
          var boundary = c.querySelector(".concept__boundary");
          if (name) md.push("### " + name.textContent.trim());
          if (def) md.push(def.textContent.trim());
          if (boundary) md.push("*" + boundary.textContent.trim() + "*");
          md.push("");
        });
      }

      /* Critical perspectives */
      var critical = document.querySelector("#panel-critical .prose");
      if (critical && critical.textContent.trim()) {
        md.push("## 批判視角");
        var critHeaders = critical.querySelectorAll("h3");
        if (critHeaders.length > 0) {
          critHeaders.forEach(function (h) {
            md.push("### " + h.textContent.trim());
            var next = h.nextElementSibling;
            while (next && next.tagName !== "H3") {
              if (next.textContent.trim()) md.push(next.textContent.trim());
              next = next.nextElementSibling;
            }
            md.push("");
          });
        } else {
          md.push(critical.textContent.trim());
          md.push("");
        }
      }

      /* Quotes */
      var quotes = document.querySelectorAll(".quote");
      if (quotes.length > 0) {
        md.push("## 精選引句");
        quotes.forEach(function (q) {
          var text = q.querySelector(".quote__text");
          var source = q.querySelector(".quote__source");
          if (text) md.push("> " + text.textContent.trim());
          if (source) md.push("> — " + source.textContent.trim());
          md.push("");
        });
      }

      /* Actions */
      var actions = document.querySelectorAll(".action-item");
      if (actions.length > 0) {
        md.push("## 行動方案");
        actions.forEach(function (a, idx) {
          var h = a.querySelector("h4");
          var p = a.querySelector("p");
          var meta = a.querySelectorAll(".action-meta span");
          md.push((idx + 1) + ". **" + (h ? h.textContent.trim() : "") + "**");
          if (p) md.push("   " + p.textContent.trim());
          meta.forEach(function (m) { md.push("   - " + m.textContent.trim()); });
          md.push("");
        });
      }

      /* Meta knowledge */
      var metaItems = document.querySelectorAll(".meta-item");
      if (metaItems.length > 0) {
        md.push("## 思維模型");
        metaItems.forEach(function (m) {
          var lens = m.querySelector(".meta-item__lens");
          var desc = m.querySelector(".meta-item__desc");
          var delta = m.querySelector(".meta-item__delta");
          if (lens) md.push("### " + lens.textContent.trim());
          if (desc) md.push(desc.textContent.trim());
          if (delta) md.push("*" + delta.textContent.trim() + "*");
          md.push("");
        });
      }

      /* Zettelkasten */
      var zettels = document.querySelectorAll(".zettel-list li");
      if (zettels.length > 0) {
        md.push("## 知識連結");
        zettels.forEach(function (z) {
          md.push("- " + z.textContent.trim());
        });
        md.push("");
      }

      /* Further reading */
      var further = document.querySelectorAll(".further-item");
      if (further.length > 0) {
        md.push("## 延伸閱讀");
        further.forEach(function (f) {
          var t = f.querySelector(".further-item__title");
          var r = f.querySelector(".further-item__reason");
          if (t) md.push("- **" + t.textContent.trim() + "**");
          if (r) md.push("  " + r.textContent.trim());
        });
        md.push("");
      }

      var text = md.join("\n");
      navigator.clipboard.writeText(text).then(function () {
        var orig = copyText.textContent;
        copyText.textContent = "已複製";
        setTimeout(function () { copyText.textContent = orig; }, 2000);
      }).catch(function () {
        /* Fallback for older browsers */
        var ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); copyText.textContent = "已複製"; setTimeout(function () { copyText.textContent = "複製為 Markdown"; }, 2000); } catch (e) {}
        document.body.removeChild(ta);
      });
    });
  })();
  </script>

</body>
</html>
